name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run tests
        run: |
          pytest -q

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push Docker image to ACR
        env:
          ACR_NAME: ${{ secrets.ACR_NAME }}
          IMAGE_NAME: data-ingestion
          IMAGE_TAG: ${{ github.sha }}
        run: |
          az acr login --name $ACR_NAME
          ACR_LOGIN_SERVER=$(az acr show -n $ACR_NAME --query loginServer -o tsv)
          docker build -t $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG .
          docker push $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG

      - name: Update App Service to use new image
        env:
          RG: ${{ secrets.AZURE_RESOURCE_GROUP }}
          APP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
          ACR_NAME: ${{ secrets.ACR_NAME }}
          IMAGE_NAME: data-ingestion
          IMAGE_TAG: ${{ github.sha }}
        run: |
          ACR_LOGIN_SERVER=$(az acr show -n $ACR_NAME --query loginServer -o tsv)
          az webapp config container set --name $APP_NAME --resource-group $RG \
            --docker-custom-image-name $ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG \
            --docker-registry-server-url https://$ACR_LOGIN_SERVER
